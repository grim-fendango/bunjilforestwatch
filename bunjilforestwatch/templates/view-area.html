{% extends "base.html" %} {% block head %}
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<style type="text/css">
html {
	height: 100%
}

body {
	height: 100%;
	margin: 10;
	padding: 10
}

#map-canvas {
	height: 100%
}
</style>
<style type="text/css"> 
/** FIX for Bootstrap and Google Maps Info window styes problem http://stackoverflow.com/questions/16708324/google-maps-infowindow-close-button-hidden **/
img[src*="gstatic.com/"], img[src*="googleapis.com/"] {
max-width: none;
}
</style>
<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDxcijg13r2SNlryEcmi_XXxZ9sO4rpr8I&sensor=false&v=3&libraries=geometry,visualization,drawing"> </script>
<script type="text/javascript" src="/static/js/draggable-object.js"></script>	
<script type="text/javascript" src="/static/js/custom-tile-overlay.js"></script>
<script type="text/javascript" src="/static/js/landsat-grid.js"></script>
<script type="text/javascript" src="/static/js/polygon-outliner.js"></script>
<script type="text/javascript" src="/static/js/drawing-tools.js"></script>
<script>

var map;
var satellite = 'l8'
var algorithm = 'rgb'; // ndvi 
var latest = 0;  //latest - 0
overlayMaps = [];

//print all the methods in javascript object - for debugging
function printMethods(object)
{
    var methods = [];
    for (var m in object) {
    	if (typeof object[m] == "function") {
        	methods.push(m);
        }
	}
	console.log(methods.join(","));
} 

function createImageOverlay(show, mapid,  token)
{
	if(show == true)
	{
	 	//CRERATE LAYER WITH SLIDER based on NZ Topo maps example.
		overlay = new CustomTileOverlay(map, initialOpacity, mapid, token);
	
		google.maps.event.addListener(map, 'tilesloaded', function () {
			overlay.deleteHiddenTiles(map.getZoom());
		});
		overlay.show();
		overlayMaps.push(overlay);
		
		// Add opacity control and set initial value
		createOpacityControl(map, initialOpacity, "Engine");	
	}
	else 
	{
		overlay = overlayMaps.pop();
		overlay.hide();
	}
}


function initialize() {
    var map_center = new google.maps.LatLng({{area.map_center}});
    var mapOptions = {
		zoom: {{ area.map_zoom }},
		center: map_center,    
		mapTypeId: google.maps.MapTypeId.HYBRID,
		panControl:true,
		zoomControl:true,
		mapTypeControl:true,
		scaleControl:true,
		streetViewControl:false,
		overviewMapControl:false,
		rotateControl:false,
		clickable: true
	}
 
    map = new google.maps.Map(document.getElementById("map-canvas"),
           mapOptions);
  
  	//wait for map to load so bounds are known before setting up landsat grid.
  	//now activated by the checkbox.
  	
  	google.maps.event.addListener(map, 'bounds_changed', function() {
   	$(landsatgrid_panel).empty();
		htmlString = "<p><font-size:50%;color:blue strong>zoom:</strong> " + map.getZoom() + "</p>";
		htmlString += "<p>lat: " + map.getCenter().lat().toFixed(3) + ", lng: " + map.getCenter().lng().toFixed(3) + "<br></p>";
		//htmlString +=  this.get("Description");
		console.log( htmlString);
		$(landsatgrid_panel).html(htmlString);
    });

   	google.maps.event.addListener(map, 'zoom', function() { 
	         	console.log("zoom to:", map.zoom());
	});
 
    //Add Area Boundary tro Map
    var latlngs = [];
    {% for j in area.coordinates %}
    	latlngs.push(new google.maps.LatLng({{j}}))
    {% endfor %}	
        
    areaBoundary = new google.maps.Polygon({
                paths: latlngs,
                strokeColor: '#FFFF00',
                strokeOpacity: 0.5,
                strokeWeight: 2,
                fillColor: '#000000',
                fillOpacity: 0.15
            });
    areaBoundary.setMap(map);
        
        // Create Overlay of Latest Landsat8
   		$('#L8latest_overlay_btn').click(function(){ 
   			
	 		var pathname = window.location.pathname + '/overlay/l8-vis/latest';
	 		$("#observations_panel").collapse('show');
	 		$('#observations_panel').empty();
	 		$('#observations_panel').append("Getting Sat Data...");
 			$('#observations_panel').append('<img src="/static/img/ajax-loader.gif" class="ajax-loader"/>');
	 		$.get(pathname)
	 		.done(function(data){
	 			mapobj = jQuery.parseJSON(data);
	 			$('#observations_panel').empty();
	 			$('#observations_panel').append("\Captured: ", mapobj.date_acquired, "\n", mapobj.id, "\nPath: ", mapobj.path, ", Row: ", mapobj.row);
	 			createImageOverlay(true, mapobj.mapid,  mapobj.token);
	 			
// 	 			var mapsEngineLayer = new google.maps.visualization.MapsEngineLayer({
//     			mapId: mapobj.mapid,
//     			token:  mapobj.token,
//     			layerKey: 'layer_00001',
//     			map: map,
// 			    clickable: 'true',
// 			    suppressInfoWindows: 'false',
//   				});
			})
	 		.error(function( jqxhr, textStatus, error ) {
	 	          var err = textStatus + ', ' + error;
	 	          console.log( "Request Failed: " + err);
		 		  $('#observations_panel').empty();
		 		  $('#observations_panel').append("<p>Failed: " + err + "</p>"); 
	 	    });
   		});
   		    
   		$('#L8NDVIlatest_overlay_btn').click(function(){ 
	 		var pathname = window.location.pathname + '/overlay/l8-ndvi/latest';
	 		$("#observations_panel").collapse('show');
	 		$('#observations_panel').empty();
	 		$('#observations_panel').append("Getting NDVI Sat Data...");
 			$('#observations_panel').append('<img src="/static/img/ajax-loader.gif" class="ajax-loader"/>');
	 		$.get(pathname)
	 		.done(function(data){
	 			mapobj = jQuery.parseJSON(data);
	 			$('#observations_panel').empty();
	 			$('#observations_panel').append("\Captured: ", mapobj.date_acquired, "\n", mapobj.id, "\nPath: ", mapobj.path, ", Row: ", mapobj.row);
	 			createImageOverlay(true, mapobj.mapid,  mapobj.token);
	 			
// 	 			var mapsEngineLayer = new google.maps.visualization.MapsEngineLayer({
//     			mapId: mapobj.mapid,
//     			token:  mapobj.token,
//     			layerKey: 'layer_00001',
//     			map: map,
// 			    clickable: 'true',
// 			    suppressInfoWindows: 'false',
//   				});
			})
	 		.error(function( jqxhr, textStatus, error ) {
	 	          var err = textStatus + ', ' + error;
	 	          console.log( "Request Failed: " + err);
		 		  $('#observations_panel').empty();
		 		  $('#observations_panel').append("<p>Failed: " + err + "</p>"); 
	 	    });
   		});
  
        
        
   		$('#L8latest_download_btn').click(function(){ 
	 		var pathname = window.location.pathname + '/download/l8-vis/latest';
	 		$("#observations_panel").collapse('show');
	 		$('#observations_panel').empty();
	 		$('#observations_panel').append("Getting Download ...");//animated gif from http://www.ajaxload.info/
 			$('#observations_panel').append('<img src="/static/img/ajax-loader.gif" class="ajax-loader"/>');
	 		$.get(pathname) //, { name: "not used", time: "notused" }
	 		.done(function(path){
	 			$('#observations_panel').empty();
	 			$('#observations_panel').append(path); 
	 			window.open(path);
	 		})
	 		.error(function( jqxhr, textStatus, error ) {
	 	          var err = textStatus + ', ' + error;
	 	          console.log( "Download Failed: " + err);
		 		  $('#observations_panel').empty();
		 		  $('#observations_panel').append("<p>Failed: " + err + "</p>"); 
	 	    });
   		});
   			
 		//Checkbox to show/hide overlays  		
   		$('.layer').click(function(){
   			var layerID = parseInt($(this).attr('id'));
   			
    		if ($(this).is(':checked')){
    			if(layerID == 0)
    			{
    				requestLandsatGrid(map, true, true);
				}
				if(layerID == 1)
    			{
	  				createDrawingManager(map);
    			}
    		} 
    		else {
	    		if(layerID == 0)
    			{
    				requestLandsatGrid(map, false, true);
           		 	removeLandsatGrid();
    			}
    			if(layerID == 1)
    			{
    				createImageOverlay(false,0,0,0);
        			//var overlayMap = new google.maps.ImageMapType(overlayMaps[layerID]);
        			//map.overlayMapTypes.setAt(layerID, overlayMap);
        		}
        	}
		});
   		
 		
   		$('#algorithm-visual').click(function(e){
           $("#algorithm:first-child").text("RGB");
           algorithm = 'rgb';
   		   e.preventDefault();
   		});
        $('#algorithm-ndvi').click(function(e){
           $("#algorithm:first-child").text("NDVI");
           algorithm = 'ndvi';
           e.preventDefault();
        });
        $('#algorithm-change').click(function(e){
           $("#algorithm:first-child").text("Change");
           algorithm = 'change';
           e.preventDefault();
        });
        
        $('#latest').click(function(e){
            $("#latest:first-child").text("Latest  ");
            latest = 0;
            e.preventDefault();
        });
        $('#latest-1').click(function(e){
            $("#latest:first-child").text("Latest-1");
            latest = 1;
            e.preventDefault();
        });
        $('#latest-2').click(function(e){
            $("#latest:first-child").text("Latest-2");
            latest = 2;
            e.preventDefault();
        });
        $('#latest-3').click(function(e){
            $("#latest:first-child").text("Latest-3");
            latest = 3;
            e.preventDefault();
        });
        
        $('#satellite').click(function(e){
            $("#satellite:first-child").text("L8");
            satellite = 'l8';
            e.preventDefault();
        });
        $('#satellite-l7').click(function(e){
            $("#satellite:first-child").text("L7");
            satellite = 'l7';
            e.preventDefault();
        });
        $('#satellite-both').click(function(e){
            $("#satellite:first-child").text("Both");
            satellite = 'both';
            e.preventDefault();
        });
        
   		$(window).resize(function () {
   				//<!--resize tip from https://github.com/twitter/bootstrap/issues/2475 -->
     	    var h = $(window).height(),
	    	        offsetTop = 60; // Calculate the top offset
	    	    $('#map-canvas').css('height', (h - offsetTop));
	    	}).resize();
   		
	};//initialize
 
    google.maps.event.addDomListener(window, 'load', initialize); 

</script>

</script>
{% endblock %} {% block content %}
<div>
	<p>
	<ul class="breadcrumb">
		<li><a href="{{ "user"|url(username) }}">{{ username }}</a> <span
			class="divider">/</span></li>
		<li class="active"><a href="{{ area|area_url }}">{{ area }}</a></li>
	</ul>
	</p>
</div>

<div class="container-fluid">
	<div class="row-fluid">
		<div class="span2">
			<!--Sidebar content <div class="control-group"> -->
			<h4>
				<i>{{area.name}}</i>
			</h4>
	        <!-- Algorithm Selection button -->
	        <div class="btn-toolbar" style="margin: 0;">
                <div class="btn-group">
                    <button id='algorithm' type="button" class="btn btn-small btn-default dropdown-toggle" data-toggle="dropdown">
                        Visual <span class="caret"></span>
                    </button>
                    <ul class="dropdown-menu" role="menu">
                       <li><a href="#" id='algorithm-visual'>Visual</a></li>
                        <li class="divider"></li>
                        <li><a href="#" id='algorithm-ndvi'>NDVI</a></li>
                        <li><a href="#" id='algorithm-change'>Change</a></li>
                    </ul>
                </div>
                <div class="btn-group">
                    <button id='latest' type="button" class="btn btn-small btn-default dropdown-toggle" data-toggle="dropdown">
                        Latest<span class="caret"></span>
                    </button>
                    <ul class="dropdown-menu" role="menu">
                       <li><a href="#" id='latest-1'>Latest-1</a></li>
                        <li class="divider"></li>
                        <li><a href="#" id='latest-2'>Latest-2</a></li>
                        <li><a href="#" id='latest-3'>Latest-3</a></li>
                    </ul>                
                </div>
                 <div class="btn-group">
                    <button id='satellite' type="button" class="btn btn-small btn-default dropdown-toggle" data-toggle="dropdown">
                        L8<span class="caret"></span>
                    </button>
                    <ul class="dropdown-menu" role="menu">
                       <li><a href="#" id='satellite-l7'>L7</a></li>
                        <li class="divider"></li>
                        <li><a href="#" id='satellite-both'>Both</a></li>
                    </ul>                
                </div>
 
            </div>  
			<div>
			<p>
				<input id="L8latest_overlay_btn" type="button" class="btn btn-primary"
					value="Get Latest Imagery" /></p>
			</div>
			<div>
			<p>
				<input id="L8NDVIlatest_overlay_btn" type="button" class="btn btn-lightgreen"
					value="Latest NDVI" /></p>
			</div>
			<div>
			<p>
				<input id="L8latest_download_btn" type="button" class="btn"
					value="Download" /></p>
			</div>	
			<div>
			<p>
				<input type="checkbox" id="0" class="layer" unchecked/><label for="0">Landsat Grid </label>
				<input type="checkbox" id="1" class=layer unchecked/><label for="1">Topo map</label>
			</div>	
			<div class="accordion" id="accordion2">
			  <div class="accordion-group">
			    <div class="accordion-heading">
			      <a class="accordion-toggle" data-toggle="collapse"  href="#description_panel">
			        Area Description
			      </a>
			    </div>
			    <div id="description_panel" class="accordion-body collapse in">
			      <div class="accordion-inner">
			        <p>{{ area.description }}</p>
			      </div>
			    </div>
			  </div>
			 
			   <div class="accordion-group">
			    <div class="accordion-heading">
			      <a class="accordion-toggle" data-toggle="collapse" href="#observations_panel">
			        Observations
			      </a>
			    </div>
			    <div id="observations_panel" class="accordion-body collapse">
			      <div class="accordion-inner">
			        <p>No Observations.<p>
			      </div>
			    </div>
			  </div>
			   <div class="accordion-group">
			    <div class="accordion-heading">
			      <a class="accordion-toggle" data-toggle="collapse" href="#reports_panel">
			        Reports
			      </a>
			    </div>
			    <div id="reports_panel" class="accordion-body collapse">
			      <div class="accordion-inner">
			        <p>No reports<p>
			      </div>
			    </div>
			  </div>
			   <div class="accordion-group">
			    <div class="accordion-heading">
			      <a class="accordion-toggle" data-toggle="collapse" href="#boundary_panel">
			        Boundary Coordinates
			      </a>
			    </div>
			    <div id="boundary_panel" class="accordion-body collapse">
			      <div class="accordion-inner">
			        {% for j in area.coordinates %}
						<p class="divider">{{j}}</p>
					{% endfor %}
			      </div>
			    </div>
			  </div>
			  <div class="accordion-group">
			    <div class="accordion-heading">
			      <a class="accordion-toggle" data-toggle="collapse" href="#map_panel">
			        Map View 
			      </a>
			    </div>
			    <div id="map_panel" class="accordion-body collapse">
			      <div class="accordion-inner">
			       	<p class="divider">"Map initial view (saved)"</p>
					<p class="divider">"Center: {{area.map_center}}"</p>
					<p class="divider">"Zoom: {{area.map_zoom}}"</p>
			      </div>
			    </div>
			  </div>
			</div>
		</div>
		<div class="span10">
			<!--Body = Map content-->
			
			<div id="map-canvas"></div>
		</div>
	</div>
</div>
{% endblock %}



{% extends "base.html" %} {% block head %}
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<style type="text/css">
html {
	height: 100%
}

body {
	height: 100%;
	margin: 10;
	padding: 10
}

#map-canvas {
	height: 100%
}
</style>
<style type="text/css"> 
/** FIX for Bootstrap and Google Maps Info window styles problem http://stackoverflow.com/questions/16708324/google-maps-infowindow-close-button-hidden **/
img[src*="gstatic.com/"], img[src*="googleapis.com/"] {
max-width: none;
}
</style>
<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDxcijg13r2SNlryEcmi_XXxZ9sO4rpr8I&sensor=false&v=3&libraries=geometry,visualization,drawing"> </script>
<script type="text/javascript" src="/static/js/draggable-object.js"></script>	
<script type="text/javascript" src="/static/js/custom-tile-overlay.js"></script>
<script type="text/javascript" src="/static/js/landsat-grid.js"></script>
<script type="text/javascript" src="/static/js/polygon-outliner.js"></script>
<script type="text/javascript" src="/static/js/drawing-tools.js"></script>
<script>

var map;
var mapobj; //returned by last call to EE image overlay.
var satellite = 'l8'
var algorithm = 'rgb'; // ndvi 
var latest = 0;  //latest - 0
overlayMaps = [];

//print all the methods in javascript object - for debugging
function printMethods(object)
{
    var methods = [];
    for (var m in object) {
    	if (typeof object[m] == "function") {
        	methods.push(m);
        }
	}
	console.log(methods.join(","));
} 

function createImageOverlay(show, mapid,  token, slider_name)
{
	if(show == true)
	{
	 	//CREATE LAYER WITH SLIDER based on NZ Topo maps example.
		overlay = new CustomTileOverlay(map, initialOpacity, mapid, token);
	
		google.maps.event.addListener(map, 'tilesloaded', function () {
			overlay.deleteHiddenTiles(map.getZoom());
		});
		overlay.show();
		overlayMaps.push(overlay);
		
		// Add opacity control and set initial value
		createOpacityControl(map, initialOpacity, slider_name.substring(5));	
	}
	else 
	{
		overlay = overlayMaps.pop();
		overlay.hide();
	}
}

function setActionUrl(action)
{
   // action can be 'overlay' or 'download' strip the old action and append the new action.
   var url = window.location.href
   if (url.indexOf("/overlay") !=-1) {
      url = url.substring(0, url.indexOf("/overlay")); //strip the last action.
   }
   if (url.indexOf("/download") !=-1) {
       url = url.substring(0, url.indexOf("/download")); //strip the last action.
   }
   if (url.indexOf("/action") !=-1) {
	      url = url.substring(0, url.indexOf("/action")); //strip the last action.
	}

   url = url + '/action/' + action + '/' + satellite + '/' + algorithm + '/' + latest;
   
   //Not working so disable the final bit.
   return url
};

function ajaxActionUrl(action)
{
   // action can be 'overlay' or 'download'.
   url = "{{ area|area_url }}"  + '/' + action + '/' + satellite + '/' + algorithm + '/' + latest;
   return url
};

function httpgetActionUrl(action)
{
   // action/<action> can be 'overlay' or 'download'.
   url = "{{ area|area_url }}"  + '/action/' + action + '/' + satellite + '/' + algorithm + '/' + latest;
   return url
};


function initialize() {
    var map_center = new google.maps.LatLng({{area.map_center}});
    var mapOptions = {
		zoom: {{ area.map_zoom }},
		center: map_center,    
		mapTypeId: google.maps.MapTypeId.HYBRID,
		panControl:true,
		zoomControl:true,
		mapTypeControl:true,
		scaleControl:true,
		streetViewControl:false,
		overviewMapControl:false,
		rotateControl:false,
		clickable: true
	}
 
    map = new google.maps.Map(document.getElementById("map-canvas"),
           mapOptions);
  
  	//wait for map to load so bounds are known before setting up landsat grid.
  	//now activated by the checkbox.
  	
  	google.maps.event.addListener(map, 'bounds_changed', function() {
   	$(landsatgrid_panel).empty();
		htmlString = "<p><font-size:50%;color:blue strong>zoom:</strong> " + map.getZoom() + "</p>";
		htmlString += "<p>lat: " + map.getCenter().lat().toFixed(3) + ", lng: " + map.getCenter().lng().toFixed(3) + "<br></p>";
		//htmlString +=  this.get("Description");
		console.log( htmlString);
		$(landsatgrid_panel).html(htmlString);
    });

   	google.maps.event.addListener(map, 'zoom', function() { 
	         	console.log("zoom to:", map.zoom());
	});
 
    //Add Area Boundary to Map
    var latlngs = [];
    {% for j in area.coordinates %}
    	latlngs.push(new google.maps.LatLng({{j}}))
    {% endfor %}	
        
    areaBoundary = new google.maps.Polygon({
                paths: latlngs,
                strokeColor: '#FFFF00',
                strokeOpacity: 0.5,
                strokeWeight: 2,
                fillColor: '#000000',
                fillOpacity: 0.15
            });
    areaBoundary.setMap(map);

    // Create Overlay of Latest Landsat8
    $('#get_overlay_btn').click(function(){
    	 _url = ajaxActionUrl("overlay");
    	httpget_url = httpgetActionUrl("overlay")
        //window.history.replaceState('string', 'load image', httpget_url);

    	//var pathname = window.location.pathname; // ie the above.
        console.log( "urls", ajax_url, httpget_url);
        $("#observations_panel").collapse('show');
	 	$('#observations_panel').empty();
	 	$('#observations_panel').append("Getting Sat Data...");
 		$('#observations_panel').append('<img src="/static/img/ajax-loader.gif" class="ajax-loader"/>');
	 	$.get(ajax_url).done(function(data) {
	 	    mapobj = jQuery.parseJSON(data);
	 	    $('#observations_panel').empty();
	 	    $('#observations_panel').append("Captured: ", mapobj.date_acquired, "\n", mapobj.id, "\nPath: ", mapobj.path, ", Row: ", mapobj.row);
	 	    createImageOverlay(true, mapobj.mapid,  mapobj.token, mapobj.date_acquired);

	    }).error(function( jqxhr, textStatus, error ) {
	    	var err = textStatus + ', ' + error;
	 	    console.log( "Request Failed: " + err);
		 	$('#observations_panel').empty();
		 	$('#observations_panel').append("<p>Failed: " + err + "</p>"); 
	 	});
    }); //get_overlay_btn.click

    //download   		    
    $('#get_download_btn').click(function(){ 
            var pathname = window.location.pathname + '/download/' + satellite + '/' + algorithm + '/' + latest;
            window.history.replaceState('string', 'load image', pathname);
	 		$("#observations_panel").collapse('show');
	 		$('#observations_panel').empty();
	 		$('#observations_panel').append("Getting Download ...");//animated gif from http://www.ajaxload.info/
 			$('#observations_panel').append('<img src="/static/img/ajax-loader.gif" class="ajax-loader"/>');
	 		$.get(pathname) //, { name: "not used", time: "notused" }
	 		.done(function(path){
	 			$('#observations_panel').empty();
	 			$('#observations_panel').append(path); 
	 			window.open(path);
	 		})
	 		.error(function( jqxhr, textStatus, error ) {
	 	          var err = textStatus + ', ' + error;
	 	          console.log( "Download Failed: " + err);
		 		  $('#observations_panel').empty();
		 		  $('#observations_panel').append("<p>Failed: " + err + "</p>"); 
	 	    });
   		});
   			
 		//Checkbox to show/hide overlays  		
   		$('.layer').click(function(){
   			var layerID = parseInt($(this).attr('id'));
   			
    		if ($(this).is(':checked')){
    			if(layerID == 0)
    			{
    				requestLandsatGrid(map, true, true);
				}
				if(layerID == 1)
    			{
	  				drawingManager = createDrawingManager(map);
                    google.maps.event.addListener(drawingManager, 'overlaycomplete', function(event) {
                        //if (event.type == google.maps.drawing.OverlayType.CIRCLE) {
                        //  var radius = event.overlay.getRadius();
                        href = "{{ "user"|url(user.name) }}/journal/Observations for {{area.name}}/new/";
                        if (mapobj != null)
                        {
                            window.location.href = href + mapobj.id;
                        }
                        else
                        {
                            window.location.href = href + "Observation"; // no overlay for this observation
                        }
                    });
                };
    		} 
    		else {
	    		if(layerID == 0)
    			{
    				requestLandsatGrid(map, false, true);
           		 	removeLandsatGrid();
    			}
    			if(layerID == 1)
    			{
    				//createImageOverlay(false,0,0,0);
                    //var overlayMap = new google.maps.ImageMapType(overlayMaps[layerID]);
                    //map.overlayMapTypes.setAt(layerID, overlayMap);
        		};
        	}
		});
   		
 		//Change the text in the drop-down button when a selection is changed.
   		$('#algorithm-visual').click(function(e){
           $("#algorithm:first-child").text("RGB");
           algorithm = 'rgb';
   		   e.preventDefault();
   		});
        $('#algorithm-ndvi').click(function(e){
           $("#algorithm:first-child").text("NDVI");
           algorithm = 'ndvi';
           e.preventDefault();
        });
        $('#algorithm-change').click(function(e){
           $("#algorithm:first-child").text("Change");
           algorithm = 'change';
           e.preventDefault();
        });
        
        $('#latest').click(function(e){
            $("#latest:first-child").text("Latest  ");
            latest = 0;
            e.preventDefault();
        });
        $('#latest-1').click(function(e){
            $("#latest:first-child").text("Latest-1");
            latest = 1;
            e.preventDefault();
        });
        $('#latest-2').click(function(e){
            $("#latest:first-child").text("Latest-2");
            latest = 2;
            e.preventDefault();
        });
        $('#latest-3').click(function(e){
            $("#latest:first-child").text("Latest-3");
            latest = 3;
            e.preventDefault();
        });
        
        $('#satellite').click(function(e){
            $("#satellite:first-child").text("L8");
            satellite = 'l8';
            e.preventDefault();
        });
        $('#satellite-l7').click(function(e){
            $("#satellite:first-child").text("L7");
            satellite = 'l7';
            e.preventDefault();
        });
        $('#satellite-both').click(function(e){
            $("#satellite:first-child").text("Both");
            satellite = 'l78';
            e.preventDefault();
        });
        
   		$(window).resize(function () {
   				//<!--resize tip from https://github.com/twitter/bootstrap/issues/2475 -->
     	    var h = $(window).height(),
	    	        offsetTop = 60; // Calculate the top offset
	    	    $('#map-canvas').css('height', (h - offsetTop));
	    	}).resize();
   		
	};//initialize
	
    google.maps.event.addDomListener(window, 'load', initialize); 

</script>
{% endblock %} {% block content %}
<div><ul class="breadcrumb">
		<li><a href="{{ "user"|url(username) }}">{{ username }}</a> <span
			class="divider">/</span></li>
		<li class="active"><a href="{{ area|area_url }}">{{ area }}</a></li>
	</ul>
</div>

<div class="container-fluid">
	<div class="row-fluid">
		<div class="span2">
			<!--Sidebar content <div class="control-group"> -->
			<h4>
				<i>Image Settings</i>
			</h4>
	        <!-- Algorithm Selection button -->
	        <div class="btn-toolbar" style="margin: 0;">
                <div class="btn-group">
                    <button id='algorithm' type="button" style="width:60px" class="btn btn-small dropdown-toggle" data-toggle="dropdown" data-toggle="tooltip" title="Select RGB for true colour or NDVI to highlight vegetation change">
                        RGB <span class="caret"></span>
                    </button>
                    <ul class="dropdown-menu" role="menu">
                       <li><a href="#" id='algorithm-visual'>RGB</a></li>
                        <li class="divider"></li>
                        <li><a href="#" id='algorithm-ndvi'>NDVI</a></li>
                        <li><a href="#" id='algorithm-change'>Change</a></li>
                    </ul>
                </div>
                <div class="btn-group">
                    <button id='latest' type="button"  style="width:60px" class="btn btn-small dropdown-toggle" data-toggle="dropdown" data-toggle="tooltip" title="Select the latest image, the one before or the one before that)">
                        Latest<span class="caret"></span>
                    </button>
                    <ul class="dropdown-menu" role="menu">
                       <li><a href="#" id='latest'>Latest</a></li>
                        <li class="divider"></li>
                        <li><a href="#" id='latest-1'>Latest-1</a></li>
                        <li><a href="#" id='latest-2'>Latest-2</a></li>
                        <li><a href="#" id='latest-3'>Latest-3</a></li>
                    </ul>                
                </div>
                <div class="btn-group">
                    <button id='satellite' type="button" style="width:40px" class="btn btn-small dropdown-toggle" data-toggle="dropdown" data-toggle="tooltip" title="Select Landsat7, Landsat 8)">
                        L8<span class="caret"></span> 
                    </button>
                    <ul class="dropdown-menu" role="menu">
                       <li><a href="#" id='satellite-l7'>L7</a></li>
                        <li class="divider"></li>
                        <li><a href="#" id='satellite-both'></a></li>
                    </ul>                
                </div>
            </div>
            <div class="row-fluid"> <br>
              <div class="btn-toolbar" style="margin: 0;">
    			 <div class="btn-group">
                    <button id='get_overlay_btn' type="button" style="width:43px" class="btn btn-small btn-lightblue" data-toggle="tooltip" title="Overlay selected image on the map">View</button>
                </div>
                 <div class="btn-group">
                    <button id='get_download_btn' type="button" style="width:65px" class="btn btn-small btn-lightgreen" data-toggle="tooltip" title="Download selected image to a (very large) file">Download</button>
                 </div>
              </div>   
    		</div>	
			<div>
			<p>
				<input type="checkbox" id="0" class="layer" unchecked data-toggle="tooltip" title="Show boundaries of landsat images"/><label for="0">Landsat Grid </label>
				<input type="checkbox" id="1" class=layer unchecked/><label for="1">Make Report</label>
			</div>	
			<div class="accordion" id="accordion2">
			  <div class="accordion-group">
			    <div class="accordion-heading">
			      <a class="accordion-toggle" data-toggle="collapse"  href="#description_panel">
			        Area Description
			      </a>
			    </div>
			    <div id="description_panel" class="accordion-body collapse in">
			      <div class="accordion-inner">
			        <p>{{ area.description }}</p>
			      </div>
			    </div>
			  </div>
			   <div class="accordion-group">
			    <div class="accordion-heading">
			      <a class="accordion-toggle" data-toggle="collapse" href="#observations_panel">
			        Observations
			      </a>
			    </div>
			    <div id="observations_panel" class="accordion-body collapse">
			      <div class="accordion-inner">
			        <p>No Observations.<p>
			      </div>
			    </div>
			  </div>
			   <div class="accordion-group">
			    <div class="accordion-heading">
			      <a class="accordion-toggle" data-toggle="collapse" href="#reports_panel">
			        Reports
			      </a>
			    </div>
			    <div id="reports_panel" class="accordion-body collapse">
			      <div class="accordion-inner">
			        <p>No reports<p>
			      </div>
			    </div>
			  </div>
			   <div class="accordion-group">
			    <div class="accordion-heading">
			      <a class="accordion-toggle" data-toggle="collapse" href="#boundary_panel">
			        Boundary Coordinates
			      </a>
			    </div>
			    <div id="boundary_panel" class="accordion-body collapse">
			      <div class="accordion-inner">
			        {% for j in area.coordinates %}
						<p class="divider">{{j}}</p>
					{% endfor %}
			      </div>
			    </div>
			  </div>
			  <div class="accordion-group">
			    <div class="accordion-heading">
			      <a class="accordion-toggle" data-toggle="collapse" href="#map_panel">
			        Map View 
			      </a>
			    </div>
			    <div id="map_panel" class="accordion-body collapse">
			      <div class="accordion-inner">
			       	<p class="divider">"Map initial view (saved)"</p>
					<p class="divider">"Center: {{area.map_center}}"</p>
					<p class="divider">"Zoom: {{area.map_zoom}}"</p>
			      </div>
			    </div>
			  </div>
			</div>
		</div>
		<div class="span10">
			<!--Body = Map content-->
			
			<div id="map-canvas"></div>
		</div>
	</div>
</div>
{% endblock %}



{% extends "base.html" %}
{% block head %}

<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />

<style type="text/css"> 
      html { 
         height: 100%;
         overflow-y:scroll /* show scroll bar */
      }
      body { height: 100%; margin: 0; padding: 0 }
      #map-canvas { height: 100%; }
</style>
    
<script type="text/javascript" src="//maps.googleapis.com/maps/api/js?key=AIzaSyDxcijg13r2SNlryEcmi_XXxZ9sO4rpr8I&sensor=false&v=3&libraries=geometry,places,visualization,drawing"> </script>
<script src="/static/js/polygon-outliner.js"></script>
<script src="/static/js/GeoJSON.js"></script>
<script type="text/javascript" src="/static/js/landsat-grid.js"></script> 
<script type="text/javascript" src="/static/js/overlay-mgr.js"></script>
<script type="text/javascript" src="/static/js/bootbox.min.js"></script>
<script type="text/javascript" src="/static/js/yaml/YamlInline.js"></script>  
<script type="text/javascript" src="/static/js/yaml/YamlParser.js"></script>  
<script type="text/javascript" src="/static/js/yaml/Yaml.js"></script>  

<script>
var map;
var map_initialised = false


var draw_boundary_instructions= 
    "<li><b>How to draw a boundary</b></li>" + 
    "<li>Drag  the map so that its center is roughly over your area. " + 
   "Or type the name of your region into the Search Box and the map center on it.</li>" + 
   "<li>Zoom the map till whole area takes up most of the view.</li>" + 
   "<li>Tick the <b>Landsat Grid</b> checkbox to see where landsat images will overlap.</li>" + 
   "<li>Create markers by clicking around the boundary in an <b>anticlockwise</b> direction.</li> " +
   "<li>When you have gone right around, click on the first marker to close the area.</li>" +
   "<li>Check the shape of your area, you can adjust it by dragging the small circles.</li>" + 
   "<li>Click _Oops! Restart_ if you made a mistake.</li>" +  
   "<li>When you are done, Recheck your zoom and map center to best show your area..</li>"  
    "<li>FInally click <b>Create Area</b>.</li>" ;

    
  var fusion_table_instructions= 
        "<li><b>How to import a fusion table</b></li>" + 
        "<li>The fusion table must either be public or shared with this bunjil's service account. </li>";
        
     
function initialize() {
	   //Radio Button Handler - Select Fusion or Draw Map 
    
	$('#new_area_form input').on('change', function() {
        var selection = $('input[name=opt-fusion]:checked', '#new_area_form').val();
        console.log("selected: ", selection);
     
        if((selection == 'is-fusion') ||(selection == 'is-drawmap')) {
            if (map_initialised == false) {
                initialize_map();
                $('#searchbox_id').fadeIn(); 
                map_initialised = true;
            }
        
            $('#createarea_id').fadeIn();
        
            if (selection == 'is-fusion') {
	        	$('#drawmap-form-c').fadeOut();
	            $('#fusiontable-form-c').fadeIn();
	            $('#boundary-instructions').html(fusion_table_instructions).fadeIn();
	            $('#reset_id').fadeOut(); // Oops button
	        } 
	        else {
	            $('#drawmap-form-c').fadeIn();
	            $('#fusiontable-form-c').fadeOut();
	            $('#boundary-instructions').html(draw_boundary_instructions).fadeIn();
	            $('#reset_id').fadeIn(); // Oops button
	        }   
        }	
    });
}

function initialize_map() {

	var center = "{{latlng}}";
    var  arr = center.split(',');
    	
     var mapOptions = {
       	    center: new google.maps.LatLng(arr[0], arr[1]),
       	    overviewMapControl: true,
       	    zoom: 3,
       	    mapTypeId: google.maps.MapTypeId.HYBRID
      };
      
      map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
       
      var creator = new PolygonCreator(map);       

      //function to add the polygon coordinates to the form data prior to submit. 
      
      $('#createarea_id').click(function(){ 
        	var problems = "";
        	var area_name =  $('#area_name').val();
            var area_descr =  $('#area_descr').val();
            var area_boundary_ft =  $('#boundary_ft').val();
            
            var selection = $('input[name=opt-fusion]:checked', '#new_area_form').val();
            
            // form validation
            if ((null == area_name) || (area_name === "")) {
                problems += 'Please give your area a short name<br/><br/>';
	        }
	        else    if(!/^[a-zA-Z 0-9]+$/.test(area_name)){ 
	             //problems += 'Sorry, Please use only the characters A-Z, a-z and 0-9 in the area name. A full name can be entered into the description\n\n';
	        }
	        if ((null == area_descr) || (area_descr=== "")) {
	            if (problems.length > 0)
	                {
	                   problems += 'Giving  your area an optional description helps others know why it should be monitored.<br/><br/>';
	                }   
	        }
            if(selection == 'is-fusion')  {
                if ((null == area_boundary_ft  )|| (area_boundary_ft == "" )) {
                    problems += 'Please provide a fusion table id.<br/><br/>';
                }
            }
            else if(selection == 'is-drawmap')  {
                if (null === creator.showData() ) {
                    problems += 'Please mark out the boundary of your area or provide a fusion table id.<br/><br/>';
                 }
            }    
            else {
                problems += 'Please select either fusion table or draw map.<br/><br/>';
            }
      
        	if (problems.length > 0) {
        		bootbox.dialog({
                      message: problems,
                      title: "Please fix these problems and then click <i>Create Area</i>",
                      buttons: {
                        success: {
                          label: "OK",
                          className: "btn-info",
                        }
                      }
                    });
        		return;
        	}

            // get and send the viewing parameters of the map
        	var unwrapped_mapcenter = map.getCenter(); // can exceed 90lat or 180 lon
            var mapcenter = new google.maps.LatLng(unwrapped_mapcenter.lat(), unwrapped_mapcenter.lng()); //wrapped.
            var mapzoom = map.getZoom();
            var newArea;
            
            if(selection == 'is-drawmap')  {
		           //convert (x,y)(x,y) to [x,y], [x,y]  > This coordstring is only printed briefly in the panel, so can be deleted.
		           var str="[" + creator.showData(); 
		           var n=str.replace(/\(/gi, "[");
		           var m=n.replace(/\)\[/gi,   "], [");
		           var coordstring=m.replace(/\)/gi, "]]");
		           $('#map_panel').append(coordstring);
		                                               
		           //format polygon string returned by showData into an array of mypoints
		           boundaryPoints = Array();
		           var x = creator.showData();
		           while(x.length > 1) {
		                var n = x.slice(x.indexOf("(")+1, x.indexOf(")") );
		                var m = n.split(",");
		                x=x.slice(x.indexOf(")")+1);
		                p= [parseFloat(m[0]), parseFloat(m[1])];
		                boundaryPoints.push(p);
		            }
		            newArea = { "type": "FeatureCollection",
                            "features": [
                               { "type": "Feature",
                                   "geometry":   {"type": "Point", "coordinates": [mapcenter.lat(), mapcenter.lng()]},
                                   "properties": {"featureName": "mapview", "zoom": mapzoom }
                               },
                               { "type": "Feature",
                                   "geometry":   {"type": "Polygon","coordinates": boundaryPoints},
                                   "properties": {"featureName": "boundary"}
                                }
                              ],
                              "boundary_ft": area_boundary_ft
                            }// End newArea

            }  
            else {
            	newArea = { "boundary_ft": area_boundary_ft
                        }// End newArea

            }
                                
            var toServer = JSON.stringify(newArea);
            document.getElementById("coordinates_id").value = toServer
            $("#new_area_form").submit();
            
         });         


        //Oops! Redraw
		$('#reset_id').click(function(){ 
		 		creator.destroy();
		 		creator=null;
		 		creator=new PolygonCreator(map);
		 });		 

		 //show paths
		 $('#showData').click(function(){ 
			     console.log("map-panel draw");
		 		$('#map_panel').empty();
		 		if(null==creator.showData()){
		 			$('#map_panel').append('Please mark out your area first, then click Create Area');
		 		}else{
		 			$('#map_panel').append(creator.showData());
		 		}
		 });

		//Checkbox to show/hide overlays  		
   		$('.layer').click(function(){
   			var layerID = parseInt($(this).attr('id'));
   			
    		if ($(this).is(':checked')){
    			if(layerID == 0)
    			{
    				createLandsatGridOverlay(map, 0.5, false, null);
				}
    		} 
    		else {
	    		if(layerID == 0)
    			{
                    createLandsatGridOverlay(map, 0, true, null);
           		 	//removeLandsatGrid();
    			}
        	}
		});
	
   	  
	 //<!--resize div tip from //github.com/twitter/bootstrap/issues/2475 -->
	 $(window).resize(function () {
	    	    var h = $(window).height(),
	    	        offsetTop = 60; // Calculate the top offset

	    	    $('#map-canvas').css('height', (h - offsetTop));
                //$('#map-canvas-c').hide();
	    	        
	  }).resize();   

          // Create the search box and link it to the UI element.
          var markers = [];
          var input = /** @type {HTMLInputElement} */(
              document.getElementById('searchbox_id'));
          map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);

          var searchBox = new google.maps.places.SearchBox(
            /** @type {HTMLInputElement} */(input));

          // Listen for the event fired when the user selects an item from the
          // pick list. Retrieve the matching places for that item.
          google.maps.event.addListener(searchBox, 'places_changed', function() {
	          var places = searchBox.getPlaces();
	          if (places.length == 0) {
	            return;
	          }
	
	          for (var i = 0, marker; marker = markers[i]; i++) {
	            marker.setMap(null);
	          }
	
	          // For each place, get the icon, place name, and location.
	          markers = [];
	          var bounds = new google.maps.LatLngBounds();
	          for (var i = 0, place; place = places[i]; i++) {
	            var image = {
	              url: '/static/img/cross-hair-target-col.png', //place.icon
	              size: new google.maps.Size(100, 100),
	              origin: new google.maps.Point(0, 0),
	              anchor: new google.maps.Point(17, 34),
	              scaledSize: new google.maps.Size(50, 50)
	            };
	
	            // Create a marker for each place.
	            var marker = new google.maps.Marker({
	              map: map,
	              icon: image,
	              draggable: true,
	              title: place.name,
	              position: place.geometry.location,
	              animation: google.maps.Animation.DROP
	            });
	          	
	          	markers.push(marker);
	
	            //setTimeout(function() {
	            //  }, 800);
	            
	            //bounds.extend(place.geometry.location);
	            map.setCenter(place.geometry.location);
	            map.setZoom(9);
	          }
          
        });
    
        google.maps.event.addListener(map, 'bounds_changed', function() {
      	    var bounds = map.getBounds();
      	    searchBox.setBounds(bounds);
      	    if (map.getZoom() > 6) {
        	   console.log ("Show Landsat Grid");
               createLandsatGridOverlay(map, 0.5, false, null);
            }
      	   else {
                //createLandsatGridOverlay(map, 0, true, null);
                //removeLandsatGrid();
      	   } 
      	});
        
        google.maps.event.addListener(map, 'idle', function() {
            //This is needed so the fusion tables query works
            var map_center = map.getCenter();
            if (map_center.lng() < -180) { 
                map.setCenter(new google.maps.LatLng(map_center.lat(), map_center.lng()+360));
            }
            if (map_center.lng() > 180) { 
                map_center.lng() -= 360;
                map.setCenter(map_center);
            }
         });
      };
    
    google.maps.event.addDomListener(window, 'load', initialize);
  
</script>    
    
{% endblock %}
{% block content %}
<!-- <div> -->
<!-- NO BREADCRUMBS REQUIRED FOR THIS PAGE -->
<!-- </div> -->
    
<div class="container">
	<div class="row">
   		<div class="col-md-3 lesspadding" >
   		  <input id="searchbox_id" class="controls" type="text" placeholder="Search by place name"  style='display:none''>
 
     		<!--Sidebar content <div class="control-group"> -->
     		<h4>Create a new Area</h4>
   			<form id="new_area_form" class="form-vertical" method="POST">
				<fieldset>
                    
					   <!--  NAME -->
					<div class="map-panel-controls">
						<label class="control-label map-panel-controls" for="name" data-toggle="tooltip"
						title="Choose a short unique name that will identify the area to others">
						Name: <span style="color: #ff0000">*</span></label>
						<input class="map-panel-controls" id="area_name" name="name" placeholder="Give your area a short name" type="text"/>
					</div>
                    <!--  DESCRIPTION  -->
	               <div class="accordion-group">
	                    <div class="accordion-heading">
	                        <a class="accordion-toggle" data-toggle="collapse" href="#area_descr_panel">Area Description</a>
	                    </div>
	                    <div id="area_descr_panel" class="accordion-body collapse in" data-toggle="collapse">
	                        <div class="accordion-inner">
						        <div class="accordion" id="inner_accordion">            
						                <div class="accordion-group">
						                    <div class="accordion-heading">
						                        <a class="accordion-toggle" data-toggle="collapse" href="#area_descr_what">Area Description</a>
						                    </div>
						                    <div id="area_descr_what" class="accordion-body collapse in" >
						                        <div class="accordion-inner small" >
                                                        <textarea rows="3" class="map-panel-controls" id="area_descr_what" name="description-what" placeholder="Tell volunteers  a little about the area or park are you protecting. You can enter a link to a wiki page" form="new_area_form"></textarea>
						                        </div>
						                    </div>
						                </div>
						                <div class="accordion-group">
						                    <div class="accordion-heading">
						                        <a class="accordion-toggle" data-toggle="collapse" href="#area_descr_why"> Why's this area important?</a>
						                    </div>
						                    <div id="area_descr_why" class="accordion-body collapse ">
						                        <div class="accordion-inner small">
								                        <textarea rows="3" class="map-panel-controls" id="area_descr_why" name="description-why" placeholder="Explain why it's important to monitor this area" form="new_area_form"></textarea>
						                        </div>
						                    </div>
						                </div>
						                 <div class="accordion-group">
                                            <div class="accordion-heading">
                                                <a class="accordion-toggle" data-toggle="collapse" href="#area_descr_who"> Who's monitoring it?</a>
                                            </div>
                                            <div id="area_descr_who" class="accordion-body collapse ">
                                                <div class="accordion-inner small">
                                                        <textarea rows="3" class="map-panel-controls" id="area_descr_who" name="description-who" placeholder="Who is going to act on reports of disturbances in this area" form="new_area_form"></textarea>
                                                </div>
                                            </div>
                                        </div>
						            </div>
	                                <div class="accordion-group">
                                            <div class="accordion-heading">
                                                <a class="accordion-toggle" data-toggle="collapse" href="#area_descr_how"> How's it protected?</a>
                                            </div>
                                            <div id="area_descr_how" class="accordion-body collapse ">
                                                <div class="accordion-inner small">
                                                        <textarea rows="3" class="map-panel-controls" id="area_descr_how" name="description-how" placeholder="How is this area protected? For example, Is it a national park or a native area? " form="new_area_form"></textarea>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                            </div>
	                </div>
	                    
    				   <!--  BOUNDARY SELECTION  -->
    				   <div>
						<fieldset class='control-label map-panel-controls'>
	                    <legend class='control-label'>How will you enter your area's boundary? <span style="color: #ff0000">*</span></legend>
	                     <div class="radio">
	                        <label><input type="radio" name="opt-fusion" value="is-drawmap">Draw my area on a map</label>
	                    </div>
	                     <div class="radio" >
	                        <label><input type="radio" name="opt-fusion" value="is-fusion">Area's boundary is in a fusion table</label>
	                    </div>
	                    </fieldset>
                    </div>
                    <!--  CREATE BUTTON  -->
                    <div class="control-group">
                        <input id = "createarea_id" type="button" class="btn btn-lightgreen map-panel-controls" value="Create Area"  style='display:none'>
                    </div>
                    <div class="control-group">
                        <input id="reset_id" type="button" class="btn btn-small btn-lightred map-panel-oops-button"  value="Oops! Restart" data-toggle="tooltip" title="Clear all the markers on the map"  style='display:none'>
                    <div class="controls">
                        <input id="coordinates_id" name="coordinates" type="hidden" value="undefined">
                    </div>  
                    
                    <div class="map-panel-fusiontable" id="fusiontable-form-c" style='display:none'>
                        <label class="control-label map-panel-controls" for="boundary_ft" data-toggle="tooltip"
                        title="If your area's boundary is already in a fusion table, link to it here.">
                        Fusion Table Id: <span style="color: #ff0000">*</span></label>
                        <input class="map-panel-controls"  id="boundary_ft" name="boundary_ft" type="text"/>
                    </div>
                    <div id="boundary-instructions" style='display:none'>
                                <placeholder>
                    </div>
                    <!--  LANDSAT GRID -->
					<div>
						<input type="checkbox" id="0" class="layer" unchecked/>
						<label for="0">Show Landsat Grid </label>
					</div>
                    <!--  MAP DIVIDER ?-->
					<div id="map_panel" class="control-group" name="panel" >
						<p class="divider"></p>
			      	</div>
			    </div>
				</fieldset>
			</form>	
		</div>
	    <!--  MAP  -->
		<div class="col-md-9 lesspadding" id="map-canvas-c" >
   			   <div id="map-canvas" > </div>
		</div>
	</div>
</div>
{% endblock %}

